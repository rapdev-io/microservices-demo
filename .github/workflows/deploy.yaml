name: Deploy Swagstore Demo
on: 
  push:
    branches: [main]

env:
  REPO_NAME: "${{ github.event.repository.name }}"
  AWS_REGION: "us-east-1"
  KUBECONFIG: "./kubeconfig"

permissions:
  id-token: write
  contents: read

jobs:
  deployment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: "${{ github.event.pull_request.head.ref }}"

      - name: Setup AWS
        uses: aws-actions/configure-aws-credentials@v4.0.0
        with:
          aws-region: "${{ env.AWS_REGION }}"
          role-to-assume: "${{ secrets.ASSUME_ROLE }}"
          role-session-name: "${{ env.REPO_NAME }}"
    
      - name: Set up Helm
        uses: Azure/setup-helm@v1
        with:
          version: '3.12.3'

      # - name: Create Kubeconfig
      #   run: aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name workshop-cluster --role-arn ${{ secrets.ASSUME_ROLE }} --kubeconfig ${{ env.KUBECONFIG }}

      - name: setup Kubectl
        uses: azure/setup-kubectl@v3
      
      - name: get pods
        run: kubectl get pods -A

      - name: Helm deploy
        run: helm upgrade --install -f ./helm-chart/values.yaml swagstore ./helm-chart
        env:
          KUBECONFIG: ${{ secrets.KUBE_CONFIG }}